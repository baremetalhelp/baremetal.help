(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[737],{29240:function(e,t,a){"use strict";a.r(t),a.d(t,{assets:function(){return u},contentTitle:function(){return c},default:function(){return h},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return p}});var n=a(87462),o=a(63366),r=(a(67294),a(3905)),i=a(93456),l=["components"],s={sidebar_position:5},c="BareMetal CDN",d={unversionedId:"cdn/index",id:"cdn/index",title:"BareMetal CDN",description:"We're going to build a Content Delivery Network, CDN, from scratch. A CDN serves web objects like images from locations that are geographically close to consumers. That means better latency for users and less load on your resources. It's a very common pattern.",source:"@site/docs/cdn/index.md",sourceDirName:"cdn",slug:"/cdn/",permalink:"/docs/cdn/",editUrl:"https://github.com/baremetalhelp/baremetal.help/docs/cdn/index.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"About BareMetal Tutorials",permalink:"/docs/intro"},next:{title:"Create AWS Organization",permalink:"/docs/organization/"}},u={},p=[{value:"Architecture",id:"architecture",level:2},{value:"Assumptions",id:"assumptions",level:2},{value:"Required Configuration",id:"required-configuration",level:2},{value:"Deploy",id:"deploy",level:2},{value:"Resources",id:"resources",level:2},{value:"Verification and Usage",id:"verification-and-usage",level:2}],m={toc:p};function h(e){var t=e.components,s=(0,o.Z)(e,l);return(0,r.kt)("wrapper",(0,n.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"baremetal-cdn"},"BareMetal CDN"),(0,r.kt)("p",null,"We're going to build a Content Delivery Network, CDN, from scratch. A CDN serves web objects like images from locations that are geographically close to consumers. That means better latency for users and less load on your resources. It's a very common pattern."),(0,r.kt)("p",null,"CDNs cache too. So you only need to copy the original to one place (the ",(0,r.kt)("em",{parentName:"p"},"origin"),") and the CDN takes care of copying to edge locations on a cache miss. Origin is an S3 Bucket, but could be an API."),(0,r.kt)("h2",{id:"architecture"},"Architecture"),(0,r.kt)(i.Mermaid,{config:{},chart:'stateDiagram-v2\n  state "AWS CloudFront" as cloudfront\n  state "Origin: AWS S3 Bucket" as origin\n  state "Route 53 HostedZone" as hosted_zone\n  state "SSL Certificate" as ssl_cert\n  state "DNS Alias Record" as a_record\n  state "AWS Certificate Manager" as acm\n  state "CloudWatch" as cloudwatch\n  state "Certificate Expiry Alarm" as expiry_alarm\n  cloudwatch --\x3e expiry_alarm\n  cloudfront --\x3e origin : read-through cache\n  hosted_zone --\x3e a_record\n  a_record --\x3e cloudfront : cdn.baremetal.help\n  acm --\x3e ssl_cert',mdxType:"Mermaid"}),(0,r.kt)("h2",{id:"assumptions"},"Assumptions"),(0,r.kt)("p",null,"See the ",(0,r.kt)("a",{parentName:"p",href:"intro#overall-assumptions"},'overall assumptions in "About BareMetal Tutorials"'),"."),(0,r.kt)("p",null,"In addition"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"You registered a domain (strongly recommended). There are more places to register domains than you can count. Here's ",(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html"},"how to do that on AWS"),". Things will go much more smoothly if you use AWS as your registrar, because the CDN stack as-is will add DNS records for the SSL certificate automatically in AWS. And you need to do that to prove you own the domain you're creating the SSL certificate for."),(0,r.kt)("li",{parentName:"ol"},"You have content \u2014 like images and CSS \u2014 you want to serve to web applications or mobile apps.")),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"You can serve content from an internal HTTP endpoint without a domain you own, but the URL of that endpoint can change if you delete and recreate the CDN."),(0,r.kt)("p",{parentName:"div"},"If you write applications that rely on the internal URL, you'll have to change them.\nIt's an random internal name created for you by AWS."),(0,r.kt)("p",{parentName:"div"},"If you just want to play with a CDN or don't have a custom domain, your best bet is to use the ",(0,r.kt)("a",{parentName:"p",href:"https://aws.amazon.com/cloudfront/"},"AWS console")," directly rather than deploy the stack for this tutorial."))),(0,r.kt)("p",null,"In this repo at the top level, run this to see a list of all the BareMetal stacks."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cdk ls\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"BareMetalCdn")," is the stack for this tutorial. You'll deploy that in a bit."),(0,r.kt)("h2",{id:"required-configuration"},"Required Configuration"),(0,r.kt)("p",null,"The CDN stack requires the following configuration."),(0,r.kt)("p",null,"In ",(0,r.kt)("inlineCode",{parentName:"p"},"config/common-config.ts"),", change the common configuration values to your domain. Provide the apex domain for publishing documentation and finding the DNS records. Provide the full hostname for the CDN."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'const bareMetalConfig: BareMetalConfig = {\n  domainName: "example.com",\n  cdnEndpoint: "cdn.example.com",\n};\n')),(0,r.kt)("h2",{id:"deploy"},"Deploy"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cdk deploy BareMetalCdn\n")),(0,r.kt)("p",null,"It'll take a little time because setting up a CDN means configuring edge locations."),(0,r.kt)("h2",{id:"resources"},"Resources"),(0,r.kt)("p",null,"The stack created the following resources."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Resource"),(0,r.kt)("th",{parentName:"tr",align:null},"AWS Resource Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"DNS A record"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"AWS::Route53::RecordSet")),(0,r.kt)("td",{parentName:"tr",align:null},"The entry in the ",(0,r.kt)("inlineCode",{parentName:"td"},"HostedZone")," for the apex domain you configured.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"SSL certificate"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"AWS::CertificateManager::Certificate")),(0,r.kt)("td",{parentName:"tr",align:null},"The SSL certificate you created for the CDN hostname.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Cloudwatch alarm"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"AWS::CloudWatch::Alarm")),(0,r.kt)("td",{parentName:"tr",align:null},"Notification before the certificate expires.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Content Delivery Network"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"AWS::CloudFront::Distribution")),(0,r.kt)("td",{parentName:"tr",align:null},"Configuration for edge locations, origin, rules.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"S3 Bucket"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"AWS::S3::Bucket")),(0,r.kt)("td",{parentName:"tr",align:null},"The origin. This is where you copy images, CSS, JS and the like so that it will appear at edge locations.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"S3 Bucket origin policy"),(0,r.kt)("td",{parentName:"tr",align:null},"AWS::S3::BucketPolicy"),(0,r.kt)("td",{parentName:"tr",align:null},"A cheeky policy on the bucket that protects access to objects in the bucket even if they're public. It does this by restricting access via a CloudFront user principal.")))),(0,r.kt)("h2",{id:"verification-and-usage"},"Verification and Usage"),(0,r.kt)("p",null,"Easy."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"action")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Copy an asset like an image to the Bucket."),(0,r.kt)("p",{parentName:"div"},"You can do this via the ",(0,r.kt)("a",{parentName:"p",href:"https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/cp.html#examples"},"AWS CLI"),"."))),(0,r.kt)("p",null,"Paths in the S3 Bucket are honored, so you append the full path of the S3 Object to the CDN endpoint."),(0,r.kt)("p",null,"For example, if you copied the image ",(0,r.kt)("inlineCode",{parentName:"p"},"abbey-road.jpg")," to the root location in S3, that image is ",(0,r.kt)("inlineCode",{parentName:"p"},"http://cdn.baremetal.help/abbey-road.jpg")," without a path. Those are musicians from my home planet, London."),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(56477).Z,width:"3124",height:"2886"})),(0,r.kt)("p",null,"Error messages for missing assets are obnoxious XML. But at least you get a ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403"},"403 HTTP")," status. "),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(15979).Z,width:"3124",height:"2886"})))}h.isMDXComponent=!0},11748:function(e,t,a){var n={"./locale":89234,"./locale.js":89234};function o(e){var t=r(e);return a(t)}function r(e){if(!a.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}o.keys=function(){return Object.keys(n)},o.resolve=r,e.exports=o,o.id=11748},56477:function(e,t,a){"use strict";t.Z=a.p+"assets/images/beatles-351e2cb0a44e656c5b50f87c95bb0367.png"},15979:function(e,t,a){"use strict";t.Z=a.p+"assets/images/cdn-403-61751b3ae6778864ff30849049843524.png"}}]);